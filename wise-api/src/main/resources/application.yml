#
#  This file contains all the defaults that it will be used when the application is started.
#  There are two main sections: SpringBoot Config and  Application Config
#

#
# SpringBoot Config: WiseMapping Backend is based on SpringBoot. Additional configurations documentation could be found https://docs.spring.io/spring-boot/3.3/reference/features/external-config.html.
#
spring:
  # Spring MVC configuration to handle exceptions gracefully
  mvc:
    log-resolved-exception: false
  # Async task executor configuration
  task:
    execution:
      pool:
        core-size: 2
        max-size: 5
        queue-capacity: 100
        keep-alive: 60s
        thread-name-prefix: "AsyncTask-"
        allow-core-thread-timeout: true
    scheduling:
      pool:
        size: 2
  # SMTP server configuration used for password recovery and notifications.
  mail:
    host: smtp.example.com
    port: 25
    username: setusername
    password: setpassword
    properties:
      mail:
        smtp:
          connectiontimeout: 30000
          timeout: 30000
          writetimeout: 30000
          starttls:
            enable: true
          ssl:
            trust: "*"
  # Database configuration options. Examples can be found: https://github.com/wisemapping/wisemapping-open-source/tree/develop/config/database
  datasource:
    url: jdbc:hsqldb:mem:wisemapping;sql.names=false;sql.regular_names=false
    driver-class-name: org.hsqldb.jdbc.JDBCDriver
    password: ''
    username: sa
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: HikariPool-WiseMapping
      minimum-idle: 2
      maximum-pool-size: 10
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-timeout: 30000
      auto-commit: true
      transaction-isolation: TRANSACTION_READ_COMMITTED
      leak-detection-threshold: 60000
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
  jpa:
    hibernate:
      ddl-auto: none
    open-in-view: true
    properties:
      hibernate:
        default_batch_fetch_size: 200
        dialect: org.hibernate.dialect.HSQLDialect
        format_sql: true
        # Enable second-level cache (L2) for entity caching across sessions
        # IMPORTANT: Mindmap-related entities (Mindmap, MindmapSpamInfo, MindmapLabel) 
        # are NOT cached to prevent inconsistencies. See ehcache.xml for details.
        cache:
          use_second_level_cache: true
          use_query_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory
        # Configure JCache provider (EHCache)
        jakarta:
          cache:
            provider: org.ehcache.jsr107.EhcacheCachingProvider
            uri: classpath:ehcache.xml
            # Suppress warning when caches are created on-the-fly during initialization
            # This occurs during startup when Hibernate accesses entities before EHCache fully loads ehcache.xml
            missing_cache_strategy: create
  sql:
    init:
      mode: always
      platform: hsqldb
  # General Config: Do no touch.
  main:
    allow-circular-references: true
  output:
    ansi:
      enabled: always
  application:
    name: wisemapping-api
    title: wisemapping-api
  # Spring Boot OAuth2 Client Configuration
  # Note: No default OAuth2 client registrations are defined here to avoid startup
  # validation when OAuth2 is disabled. Provide registrations in your external app.yml
  # only when enabling OAuth2 (google/facebook).
  security:
    oauth2:
      client:
        #
        # OAuth2 Registrations (commented examples)
        # Uncomment and configure when enabling OAuth2 providers.
        #
        # registration:
        #   google:
        #     client-id: your-google-client-id
        #     client-secret: your-google-client-secret
        #     scope: openid,profile,email
        #     redirect-uri: "${app.site.api-base-url}/login/oauth2/code/{registrationId}"
        #   facebook:
        #     client-id: your-facebook-client-id
        #     client-secret: your-facebook-client-secret
        #     scope: email,public_profile
        #     redirect-uri: "${app.site.api-base-url}/login/oauth2/code/{registrationId}"
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
          facebook:
            authorization-uri: https://www.facebook.com/v18.0/dialog/oauth
            token-uri: https://graph.facebook.com/v18.0/oauth/access_token
            user-info-uri: https://graph.facebook.com/me?fields=id,email,first_name,last_name
            user-name-attribute: id
#
# OpenTelemetry Resource Attributes
#
otel:
  resource:
    attributes:
      service:
        name: wisemapping-api
        version: 6.0.0

#
# Log Level
#
logging:
  level:
    org:
      apache:
        tomcat: INFO
        catalina:
          core:
            StandardWrapperValve: OFF
    root: INFO
    com:
      wisemapping:
        scheduler:
          SpamDetectionScheduler: DEBUG

resilience4j:
  ratelimiter:
    instances:
      mindmapUpdateLimiter:
        limitForPeriod: 30
        limitRefreshPeriod: 1s
        timeoutDuration: 0
      mindmapCreateLimiter:
        limitForPeriod: 20
        limitRefreshPeriod: 1s
        timeoutDuration: 0

#
# Application Config related options:
#
app:
  monitoring:
    performance:
      log-mindmap-listing: false
      log-account-listing: true
  # This information is mainly used by the frontend to connect to the backend. It must match the deployment topology used.
  site:
    ui-base-url: http://localhost:3000
    api-base-url: http://localhost:8080
  # Enable API basic authentication.
  api:
    http-basic-enabled: false
  # JSON Web Token configuration options. Secret must be configured.
  jwt:
    secret: dlqxKAg685SaKhsQXIMeM=JWCw3bkl3Ei3Tb7LMlnd19oMd66burPNlJ0Po1qguyjgpakQTk2CN3
    expirationMin: 10080 # One week
  # Admin account with super admin permissions on the API.
  admin:
    user: admin@wisemapping.org
  # ChatGPT OAuth integration configuration
  chatgpt:
    ai-base-url: https://ai.wisemapping.com
  # STMP email configurations
  mail:
    sender-email: root@localhost
    support-email: root@localhost
    enabled: false
  accounts:
    max-inactive: 10  # Maximum total inactive collaborators across all mindmaps
    #corsAllowedOrigins: https://app.wisemapping.com,https://wisemapping.com,https://dev.wisemapping.com,http://localhost:3000
  # Batch task configuration
  batch:
    spam-user-suspension:
      enabled: true
      startup-enabled: false  # Enable spam user suspension on application startup (async)
      cron-expression: "0 0 18 * * *"  # Once a day at 6 PM Argentina time (America/Argentina/Buenos_Aires timezone)
      months-back: 3  # Only process accounts created in the last 3 months
      batch-size: 50  # Number of users to process in each batch
      # Two-condition suspension criteria
      public-spam-ratio-threshold: 0.75  # Condition 1: Users with >= 75% of public maps marked as spam will be suspended
      min-any-spam-count: 4  # Condition 2: Users with >= 4 spam maps (public or private) will be suspended
    spam-detection:
      enabled: true
      cron-expression: "0 0 0 * * *"  # Every 24 hours at midnight
      batch-size: 100  # Number of mindmaps to process in each batch
      min-nodes-exemption: 15  # Mindmaps with more than this many nodes are automatically considered not spam
      max-description-length: 200  # Maximum description length before considering as potential spam
      startup-enabled: true  # Enable spam detection on application startup (async)
      months-back: 60  # Only process mindmaps created in the last 60 months
      version: 7  # Current spam detection version - increment this to skip processing mindmaps with higher or equal version
      service-directory:
        keyword-stuffing-separators: 25  # Number of separator characters (pipes, commas) indicating keyword stuffing
        location-variants: 8  # Number of distinct location variants (cities, neighborhoods) indicating keyword stuffing
        near-me-repetitions: 10  # Number of "near me" and similar phrase repetitions indicating keyword stuffing
      link-farm:
        url-threshold: 20  # Absolute threshold for URL count (always spam if >= this)
        url-threshold-low-structure: 10  # URL threshold for maps with <= 3 topics
        max-topics-for-low-structure: 3  # Maximum topics to consider as "low structure"
        popular-domain-whitelist-resource: classpath:spam/popular-domain-whitelist.yml  # Domains ignored when counting URLs for link farm detection
    history-cleanup:
      enabled: true
      startup-enabled: false  # Disable startup execution by default (can be heavy)
      cron-expression: "0 0 21 * * SAT"  # Every Saturday at 9:00 PM (21:00) Argentina time
      # Two-phase history cleanup approach:
      # Phase 1: Complete history removal for moderately old mindmaps
      #   - Maps between phase1-lower-boundary-years and phase1-upper-boundary-years have ALL history removed
      #   - This targets mindmaps that are old enough that detailed history is no longer valuable
      #   - Example: Maps between 1-2 years old get all history deleted
      phase1-lower-boundary-years: 2  # Lower boundary for Phase 1 (maps older than this)
      phase1-upper-boundary-years: 1  # Upper boundary for Phase 1 (maps newer than this)
      # Phase 2: Selective history retention for recent mindmaps
      #   - Maps between phase2-lower-boundary-years and phase2-upper-boundary-years keep only the most recent entries
      #   - This preserves recent activity while removing older history to save space
      #   - Example: Maps between 6 months and 1 year old keep only the 4 most recent history entries
      phase2-lower-boundary-years: 1  # Lower boundary for Phase 2 (maps older than this)
      phase2-upper-boundary-years: 0.5  # Upper boundary for Phase 2 (maps newer than this)
      phase2-max-entries: 4  # Maximum number of recent entries to keep per mindmap
      batch-size: 100  # Number of mindmaps to process in each batch to prevent memory issues
    inactive-user-suspension:
      enabled: true
      startup-enabled: false  # Enable inactive user suspension on application startup (async)
      cron-expression: "0 0 9 * * SAT"  # Every Saturday at 9:00 AM Argentina time
      preview-enabled: false  # Enable preview task on Fridays
      inactivity-years: 7  # Users inactive for this many years will be suspended
      grace-period-years: 1  # Additional grace period beyond inactivity threshold (inactivity-years + grace-period-years = minimum account age)
      batch-size: 100  # Number of users to process in each batch
      dry-run: false  # Set to true for testing without actual suspension
    inactive-mindmap-migration:
      enabled: true
      startup-enabled: false  # Disable startup execution by default
      cron-expression: "0 0 15 * * SAT"  # Every Saturday at 3:00 PM (15:00) Argentina time
      batch-size: 25  # Number of users to process in each batch (reduced for memory efficiency)
      mindmap-batch-size: 10  # Number of mindmaps to process in each sub-batch (memory optimization)
      dry-run: false  # Set to true for testing without actual migration
  #  accounts:
  #    exclusion:
  # Mindmap content configuration
  mindmap:
    note:
      max-length: 10000  # Maximum allowed characters in mindmap notes
  # Account registration options dialog
  registration:
    enabled: true
    # Require email confirmation for DATABASE users (OAuth users are auto-activated)
    email-confirmation-enabled: true
    # Google reCAPTCHA v2 configuration (disabled by default)
    # To enable: set enabled to true and provide your reCAPTCHA keys from https://www.google.com/recaptcha/admin
    captcha:
      enabled: false
      siteKey: ''
      secretKey: ''
    disposable-email:
      blocking:
        enabled: true


# Behind reverse proxy configuration
server:
  tomcat:
    remoteip:
      remote-ip-header: x-forwarded-for
      protocol-header: x-forwarded-proto

monitoring:
  performance:
    log-mindmap-listing: false

# Spring Boot Actuator configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: wisemapping-api
    export:
      step: 60s
  otlp:
    metrics:
      export:
        enabled: false
        url: https://otlp.nr-data.net/v1/metrics
        step: 60s
        headers:
          api-key: your-new-relic-license-key-here