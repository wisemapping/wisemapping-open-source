<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://www.ehcache.org/v3"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:jsr107="http://www.ehcache.org/v3/jsr107"
        xsi:schemaLocation="
            http://www.ehcache.org/v3 http://www.ehcache.org/schema/ehcache-core.xsd
            http://www.ehcache.org/v3/jsr107 http://www.ehcache.org/schema/ehcache-107-ext.xsd">

    <!-- 
        NOTE: Mindmap-related entities (MindmapSpamInfo, MindmapLabel) are NOT cached
        to prevent inconsistencies. Mindmap data changes frequently and must always
        reflect the latest state in the database.
        
        IMPORTANT CACHE CONSISTENCY CONSIDERATION:
        - Mindmap entity uses EAGER fetch for Account creator (@ManyToOne fetch = EAGER)
        - Account cache TTL reduced to 60s idle, 300s total (from 600s/3600s) - IMPLEMENTED
        - Explicit cache eviction added on Account suspension/activation updates - IMPLEMENTED
        - This minimizes stale Account data when loading Mindmap
        - Critical fields protected: suspended status, activation status
        - Long-term evaluation: Monitor if Account caching is still beneficial given consistency requirements
    -->

    <service>
        <jsr107:defaults>
            <jsr107:cache name="com.wisemapping.model.Collaborator" template="collaborator-template"/>
            <jsr107:cache name="com.wisemapping.model.Account" template="account-template"/>
            <jsr107:cache name="default-query-results-region" template="query-results-template"/>
            <jsr107:cache name="default-update-timestamps-region" template="update-timestamps-template"/>
        </jsr107:defaults>
    </service>
    
    <!-- 
        Entity Cache Regions - Second Level Cache for JPA Entities
        These caches store entity instances across sessions.
    -->
    <cache-template name="collaborator-template">
        <key-type>java.lang.Object</key-type>
        <value-type>java.lang.Object</value-type>
        <expiry>
            <tti unit="seconds">600</tti>
            <ttl unit="seconds">3600</ttl>
        </expiry>
        <resources>
            <heap unit="entries">2000</heap>
        </resources>
    </cache-template>

    <!-- 
        Account cache: Reduced TTL (60s idle, 300s total) to minimize staleness when
        loaded by non-cached Mindmap entities.
    -->
    <cache-template name="account-template">
        <key-type>java.lang.Object</key-type>
        <value-type>java.lang.Object</value-type>
        <expiry>
            <tti unit="seconds">60</tti>
            <ttl unit="seconds">300</ttl>
        </expiry>
        <resources>
            <heap unit="entries">2000</heap>
        </resources>
    </cache-template>
    
    <!-- 
        default-query-results-region: Stores query results (IDs and values)
        Limit: 2000 entries
        TTL: 3600 seconds (1 hour) - queries can become stale, so we limit lifetime
        TTI: 600 seconds (10 minutes) - evict unused queries after 10 minutes
    -->
    <cache-template name="query-results-template">
        <key-type>java.lang.Object</key-type>
        <value-type>java.lang.Object</value-type>
        <expiry>
            <tti unit="seconds">600</tti>
            <ttl unit="seconds">3600</ttl>
        </expiry>
        <resources>
            <heap unit="entries">2000</heap>
        </resources>
    </cache-template>
    
    <!-- 
        default-update-timestamps-region: Tracks when database tables were last updated
        Used by Hibernate to invalidate query cache when underlying data changes.
        Limit: 1000 entries (one per table typically)
        TTL: 3600 seconds (1 hour) 
        TTI: 600 seconds (10 minutes)
    -->
    <cache-template name="update-timestamps-template">
        <key-type>java.lang.Object</key-type>
        <value-type>java.lang.Object</value-type>
        <expiry>
            <tti unit="seconds">600</tti>
            <ttl unit="seconds">3600</ttl>
        </expiry>
        <resources>
            <heap unit="entries">1000</heap>
        </resources>
    </cache-template>
</config>
